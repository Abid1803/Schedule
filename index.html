<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Schedule</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center mb-4">Daily Schedule</h1>
    <div id="clock" class="text-center mb-3" style="font-size: 24px;"></div>
    <div id="countdown" class="text-center mb-3 font-weight-bold" style="font-size: 20px;"></div>
    <div id="schedule"></div>
  </div>

  <script>
    const scheduleData = [
      { time: "9:00 - 10:00", activity: "Operating Systems" },
      { time: "10:00 - 11:00", activity: "Advanced DSA Practice" },
      { time: "11:00 - 12:00", activity: "Aptitude + Verbal & Logical Reasoning" },
      { time: "12:00 - 1:00", activity: "Break / Leisure" },
      { time: "1:00 - 2:00", activity: "Machine Learning" },
      { time: "2:00 - 3:00", activity: "Lunch / Rest" },
      { time: "3:00 - 4:00", activity: "Mock Interviews / Projects" },
      { time: "4:00 - 5:00", activity: "Core CS Revision (OS, DBMS, CN, OOPs)" },
      { time: "5:00 - 6:00", activity: "Resume Building / Contest Review" },
      { time: "6:00 - 7:00", activity: "Dinner & Relaxation" },
      { time: "7:00 - 8:00", activity: "Free Time / Hobby Learning" },
      { time: "8:00 - 10:00", activity: "CodeChef Weekly Contest (Wednesday) / DSA" },
      { time: "10:00 - 11:00", activity: "Day Review + Plan Next Day" },
    ];

    let notificationTimeouts = [];
    let currentCountdownInterval = null;
    let lastResetCheck = null;

    function parseTime(t) {
      const match = t.match(/(\d{1,2}):(\d{2})/);
      if (!match) return 0;
      const hour = parseInt(match[1], 10);
      const minute = parseInt(match[2], 10);
      return hour * 60 + minute;
    }

    function showNotification(title, body) {
      if (Notification.permission === 'granted') {
        new Notification(title, { body });
      }
    }

    function scheduleTaskNotifications(startMin, endMin, activity) {
      const now = new Date();
      const currentMin = now.getHours() * 60 + now.getMinutes();

      if (startMin > currentMin) {
        notificationTimeouts.push(setTimeout(() => showNotification("Task Starting", `It's time for: ${activity}`), (startMin - currentMin) * 60000));
      }

      if (endMin > currentMin) {
        notificationTimeouts.push(setTimeout(() => showNotification("Task Ended", `${activity} has ended.`), (endMin - currentMin) * 60000));
      }
    }

    function startCountdown(endMinutes) {
      if (currentCountdownInterval) clearInterval(currentCountdownInterval);

      function updateCountdown() {
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        const diff = endMinutes - currentMinutes;
        const countdownDiv = document.getElementById("countdown");

        if (diff > 0) {
          const hours = Math.floor(diff / 60);
          const minutes = diff % 60;
          countdownDiv.textContent = `⏳ ${hours ? hours + " hr " : ""}${minutes} min remaining`;
        } else {
          countdownDiv.textContent = "✅ Task Completed or Starting Soon";
          clearInterval(currentCountdownInterval);
        }
      }

      updateCountdown();
      currentCountdownInterval = setInterval(updateCountdown, 60000);
    }

    function loadTasks() {
      notificationTimeouts.forEach(timeout => clearTimeout(timeout));
      notificationTimeouts = [];
      const container = document.getElementById("schedule");
      container.innerHTML = "";

      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      const today = now.toDateString();
      let currentTask = null;

      scheduleData.forEach((task, index) => {
        const [start, end] = task.time.split(" - ");
        const startMin = parseTime(start);
        const endMin = parseTime(end);
        const isCurrent = currentMinutes >= startMin && currentMinutes < endMin;

        if (isCurrent) {
          currentTask = { ...task, startMinutes: startMin, endMinutes: endMin };
        }

        const taskDiv = document.createElement("div");
        taskDiv.className = `border p-3 mb-2 ${isCurrent ? 'bg-warning' : ''}`;
        taskDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${task.time}</strong> — ${task.activity}
            </div>
            <input type="checkbox" id="task${index}" ${isCurrent ? "disabled" : ""}>
          </div>
        `;
        container.appendChild(taskDiv);
      });

      if (currentTask) {
        startCountdown(currentTask.endMinutes);
        scheduleTaskNotifications(currentTask.startMinutes, currentTask.endMinutes, currentTask.activity);
      }

      resetCheckboxesIfLastTaskFinished(currentMinutes, today);
    }

    function resetCheckboxesIfLastTaskFinished(currentMinutes, today) {
      const lastTaskEnd = parseTime(scheduleData[scheduleData.length - 1].time.split(" - ")[1]);
      if (currentMinutes >= lastTaskEnd && lastResetCheck !== today) {
        scheduleData.forEach((_, i) => {
          const checkbox = document.getElementById(`task${i}`);
          if (checkbox) checkbox.checked = false;
        });
        lastResetCheck = today;
      }
    }

    function startClock() {
      const clockDiv = document.getElementById("clock");
      function updateClock() {
        const now = new Date();
        clockDiv.textContent = now.toLocaleTimeString();
      }
      updateClock();
      setInterval(updateClock, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      if ('Notification' in window) {
        Notification.requestPermission();
      }
      navigator.serviceWorker?.register("sw.js").catch(console.error);
      loadTasks();
      startClock();
    });
  </script>
</body>
</html>
